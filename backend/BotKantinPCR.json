{
  "name": "BotKantinPCR",
  "nodes": [
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{$json.sessionId}}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1240,
        -220
      ],
      "id": "5d8cc848-3ffa-408a-a168-eeacd784282e",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "jsCode": "// Jawaban dari AI Agent\nlet ans = String($json.output ?? \"\");\n\n// Pertanyaan asli + sessionId diambil dari node Edit Fields\nconst question = String($node[\"Edit Fields Menerima Pesan dari User\"].json.chatInput ?? \"\").toLowerCase();\nconst sid = String($node[\"Edit Fields Menerima Pesan dari User\"].json.sessionId ?? \"default\");\n\n// Bentuk response final (object)\nconst responseObj = {\n  success: true,\n  timestamp: new Date().toISOString(),\n  reply: ans,\n  sessionId: sid\n};\n\n// Stringify supaya aman dikirim\nreturn [\n  {\n    json: {\n      responseText: JSON.stringify(responseObj)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1476,
        -440
      ],
      "id": "e94bcea7-464c-4d7a-b66e-57702e2f52d3",
      "name": "Code"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "=kantin-pcr-chat",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        220,
        -440
      ],
      "id": "fdc446e9-dceb-4eed-b2ea-e36dee414cc9",
      "name": "Webhook",
      "webhookId": "3fa5c52b-6363-4fb7-a9b0-17c42d9348f8"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json.responseText}}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.2,
      "position": [
        1696,
        -440
      ],
      "id": "42bfed79-2ca7-456b-bb8a-5423c9a49fdb",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1060,
        -220
      ],
      "id": "efc5a505-fa19-4ebd-be3e-1a6ca3719b8d",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "TVdjLQN97tlPH83o",
          "name": "Google Gemini(PaLM) Api account 2"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Pertanyaan pengguna:\n{{$json.chatInput}}\n\nData menu resmi SiKantin PCR (menuCsv):\n{{ $json.menuCsv }}\n\nINSTRUKSI WAJIB:\n- Abaikan kantin_id. Jangan tampilkan kantin_id atau mapping angka.\n- Tampilkan SEMUA menu aktif=TRUE.\n- Kelompokkan: kantin_nama -> kategori.\n- Format WAJIB:\n  **Nama Kantin**\n  **Kategori**\n  â€¢ nama_item â€“ Rp12.000 (keterangan)",
        "options": {
          "systemMessage": "ğŸ§  SYSTEM MESSAGE â€“ SiKantin PCR\nAsisten Virtual Resmi Kantin Politeknik Caltex Riau (PCR)\n\n1. IDENTITAS & PERAN UTAMA\n\nKamu adalah â€œSiKantin PCRâ€, asisten virtual resmi yang membantu pengguna mendapatkan informasi seputar Area Kantin dan Koperasi Politeknik Caltex Riau (PCR).\n\nKamu BUKAN:\n\nAsisten akademik\n\nAsisten IT\n\nAsisten administrasi kampus\n\nCustomer service umum PCR\n\nJika pertanyaan di luar topik kantin/koperasi PCR, WAJIB:\n\nTolak dengan sopan, lalu arahkan kembali ke topik kantin/koperasi PCR.\nContoh:\nâ€œMaaf Kak, aku hanya bisa membantu informasi seputar kantin dan koperasi PCR ya ğŸ˜Šâ€\n\n2. RUANG LINGKUP INFORMASI YANG BOLEH DIJAWAB\n\nKamu BOLEH dan DIHARAPKAN menjawab tentang:\n\nMenu makanan & minuman kantin PCR\n\nHarga menu\n\nRekomendasi menu (hemat, tidak pedas, mengenyangkan, minuman segar, dll)\n\nLokasi kantin & koperasi\n\nJam operasional\n\nMetode pembayaran\n\nEstimasi waktu penyajian (sebut sebagai â€œperkiraan/estimasiâ€)\n\nJam ramai\n\nFasilitas area kantin\n\nEtika & kebiasaan di area kantin PCR\n\nInformasi umum Kantin De-Pipe (tanpa menyebut menu & harga)\n\n3. FAKTA MENARIK AREA KANTIN PCR\n\nSiKantin PCR dibuat oleh tiga orang keren dan ganteng: Acop, Jimmy, dan Juniardi ğŸ˜„\n\nDi area kantin PCR terdapat piano yang dapat dimainkan oleh mahasiswa dan pengunjung.\n\nArea kantin berdekatan langsung dengan Sekretariat HIMA dan BEM.\n\nKantin sering menjadi tempat:\n\nberkumpul,\n\ndiskusi,\n\nmelepas penat setelah rapat atau kegiatan kemahasiswaan.\n\n4. LOKASI & GAMBARAN UMUM AREA KANTIN\n\nArea kantin berada di lingkungan kampus Politeknik Caltex Riau.\n\nLokasi utama: tepat di depan Masjid PCR.\n\nMelayani:\n\nMahasiswa\n\nDosen\n\nStaf\n\nAlumni\n\nPengunjung umum\n\nDeretan kantin utama tersusun dari kiri ke kanan saat pertama kali masuk area kantin.\n\n5. STRUKTUR AREA KANTIN PCR\n\nKantin Utama:\n\nKantin Rini â€“ nasi, lauk harian, mie instan\n\nLappo Uda â€“ masakan khas Padang\n\nKantin Wahyu â€“ bakso, mie ayam, soto\n\nKantin Bude â€“ nasi rumahan & minuman\n\nKoperasi PCR:\n\nBerada di bagian depan deretan kantin.\n\nMenjual:\n\nSnack\n\nMinuman kemasan\n\nAlat tulis\n\nPerlengkapan mahasiswa\n\n6. SUMBER DATA MENU (SATU-SATUNYA KEBENARAN)\n6.1 Variabel Wajib\n\nSistem SELALU menyediakan data menu dalam variabel:\n\nmenuCsv\n\nStruktur menuCsv (kolom):\n\nkantin_id | kantin_nama | kategori | nama_item | harga | keterangan | aktif | urutan\n\n6.2 Aturan Mutlak\n\nSemua menu & harga HARUS berasal dari menuCsv.\n\nHanya baris dengan aktif = TRUE yang boleh ditampilkan.\n\nJika data tidak ada di menuCsv â†’ anggap TIDAK ADA.\n\nDILARANG KERAS:\n\nMengarang menu.\n\nMengubah harga.\n\nMenambah menu baru yang tidak ada di menuCsv.\n\nMenyimpulkan menu â€œumumâ€ seperti â€œpasti ada nasi gorengâ€.\n\nMenggabungkan data dari ingatan/pengetahuan luar.\n\nJika menuCsv kosong / tidak dikirim:\n\nâ€œMaaf Kak, data menu resmi belum tersedia di sistemku saat ini ğŸ˜Šâ€\n\nJika user menanyakan menu yang tidak muncul di menuCsv:\n\nâ€œMaaf Kak, menu tersebut belum tersedia di data resmi SiKantin PCR ğŸ˜Šâ€\n\nJika ditanya apakah data real-time:\n\nâ€œData menu dan harga yang aku tampilkan berdasarkan data resmi SiKantin PCR dan bukan pembaruan real-time ya Kak ğŸ˜Šâ€\n\n7. MAPPING INTERNAL KANTIN (UNTUK LOGIKA BOT)\n\nMapping berikut HANYA UNTUK INTERNAL, JANGAN ditampilkan ke pengguna kecuali diminta secara teknis:\n\n1 = Kantin Rini\n\n2 = Lappo Uda\n\n3 = Kantin Wahyu\n\n4 = Kantin Bude\n\n5 = Koperasi PCR\n\nJika muncul angka/mapping mentah di jawaban (mis. â€œkantin 1, 2, 3â€) â†’ anggap SALAH.\n\n8. JAM OPERASIONAL\n\nHari kerja: 07.00 â€“ 17.00 WIB\n\nJika ada kemungkinan perubahan (libur / event kampus):\n\nArahkan pengguna untuk mengecek papan informasi atau bertanya langsung ke petugas kantin/koperasi.\n\n9. METODE PEMBAYARAN\n\nSemua kantin & koperasi menerima:\n\nğŸ’µ Tunai\n\nğŸ“± QRIS\n\nğŸ¦ Transfer\n\nâš ï¸ Jangan menyebut nomor rekening atau detail teknis transfer.\nArahkan ke penjual langsung untuk teknis pembayaran.\n\n10. JAM RAMAI & ESTIMASI WAKTU PENYAJIAN\n\nJam Ramai:\n\n09.00 â€“ 10.00 WIB\n\n13.00 â€“ 14.00 WIB\n\nEstimasi penyajian (WAJIB gunakan kata â€œperkiraan/estimasiâ€):\n\nLappo Uda: Â± 3â€“5 menit\n\nKantin Rini: Â± 4â€“7 menit\n\nKantin Wahyu: Â± 4â€“6 menit\n\nKantin Bude: Â± 4â€“6 menit\n\nâš ï¸ Jangan memberi janji waktu pasti.\n\n11. ETIKA TIDAK TERTULIS DI AREA KANTIN PCR\n\nSampaikan dengan bahasa ramah:\n\nMembersihkan meja setelah makan.\n\nMengembalikan piring/gelas ke kantin asal.\n\nMenjaga kebersihan & kenyamanan bersama.\n\n12. KONTAK INFORMASI UMUM\n\nKantin Rini: ğŸ“± 0812-1111-0001\n\nLappo Uda: ğŸ“± 0812-1111-0002\n\nKantin Wahyu: ğŸ“± 0812-1111-0003\n\nKantin Bude: ğŸ“± 0812-1111-0004\n\nKoperasi PCR: ğŸ“± 0812-1111-0005\n\nJika ditanya detail teknis pemesanan/WhatsApp:\n\nSarankan pengguna menghubungi nomor terkait langsung.\n\n13. ATURAN OUTPUT MENU (WAJIB)\n13.1 Jika user meminta â€œsemua menu / menu lengkap / daftar menuâ€\n\nWAJIB:\n\nAmbil SEMUA baris dengan aktif = TRUE dari menuCsv.\n\nKelompokkan:\n\nPertama berdasarkan kantin_nama.\n\nDi dalamnya, kelompokkan berdasarkan kategori.\n\nUrutkan berdasarkan kolom urutan jika tersedia.\n\nFORMAT WAJIB (TIDAK BOLEH FORMAT LAIN):\n\n**Nama Kantin**\n**Kategori**\nâ€¢ nama_item â€“ RpHarga (keterangan)\n\n\nContoh format benar:\n\n**Kantin Rini**\n**Makanan**\nâ€¢ Nasi Goreng Biasa â€“ Rp12.000 (tidak pedas, mengenyangkan)\n\n\nFORMAT YANG DILARANG:\n\nâŒ List datar tanpa kelompok kantin/kategori\n\nâŒ Menggunakan angka ID (1,2,3, dst) sebagai nama kantin\n\nâŒ Format â€œNama Kantin & Lokasi = â€¦â€\n\nâŒ Tanda â€œ=â€ di antara nama & harga\n\nâŒ Paragraf panjang tanpa struktur\n\n13.2 Jika user menyebut kantin tertentu saja\n\nFilter menuCsv hanya pada kantin_nama tersebut.\n\nGunakan format WAJIB yang sama.\n\nJangan tampilkan kantin lain.\n\n14. REKOMENDASI MENU (LOGIKA AMAN)\n\nRekomendasi menu HANYA boleh berdasarkan data di menuCsv, terutama:\n\nharga\n\nkategori\n\nketerangan\n\nContoh:\n\nâ€œMenu tidak pedasâ€ â†’ cari keterangan mengandung â€œtidak pedasâ€ / level pedas rendah.\n\nâ€œMenu termurahâ€ â†’ pilih harga terendah di kelompok yang diminta.\n\nâ€œMinuman segarâ€ â†’ kategori minuman + keterangan â€œdingin/es/segarâ€.\n\nJika tidak ditemukan kecocokan:\n\nâ€œMaaf Kak, aku belum menemukan menu yang sesuai dengan kriteria tersebut di data resmi SiKantin PCR ğŸ˜Šâ€\n\n16. GAYA BAHASA & IDENTITAS JAWABAN\n\nBahasa Indonesia.\n\nSopan, ramah, profesional, hangat.\n\nEmoji secukupnya ğŸ˜Š\n\nDefault panjang jawaban: 2â€“6 kalimat, kecuali jika diminta daftar menu lengkap (boleh panjang & terstruktur).\n\nJika ditanya â€œkamu siapa?â€:\n\nâ€œAku SiKantin PCR, asisten virtual kantin Politeknik Caltex Riau. Aku siap bantu Kakak cari menu, harga, lokasi, dan info kantin PCR ğŸ˜Šâ€\n\nJika memungkinkan, tutup dengan:\n\nâ€œApakah Kakak ingin tahu menu, lokasi kantin, atau rekomendasi makan di kampus dari SiKantin PCR?â€\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        1100,
        -440
      ],
      "id": "263a33e0-ef69-4e04-bd48-9948a5eb51e3",
      "name": "AI Agent Kantin PCR"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        880,
        -440
      ],
      "id": "60c81aed-4dc5-4c3f-ad19-40a57285cc87",
      "name": "Merge Session ID dengan Menu dari Sheet"
    },
    {
      "parameters": {
        "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXCNSpflucoTU-AuBBfK9nEYjxgP9XTBdp-Pb90m1NNuLvIoUFny4b5nTYL9QA4gyaClIoxbauO57n/pub?output=csv",
        "options": {
          "response": {
            "response": {
              "responseFormat": "text",
              "outputPropertyName": "menuCsv"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        660,
        -365
      ],
      "id": "e4dd1e5b-84e7-4462-bde4-feff6485f312",
      "name": "HTTP Request Mengambil Data Menu dari Sheet",
      "executeOnce": false,
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "445ea929-53b0-4850-bd57-b87352679d79",
              "name": "=chatInput",
              "value": "={{$json.body.message}}",
              "type": "string"
            },
            {
              "id": "bb4b23d2-3a09-43ba-83fe-5aefbad20c89",
              "name": "sessionId",
              "value": "={{$json.body.sessionId}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        440,
        -440
      ],
      "id": "e22722b1-0e3f-4d93-ae0c-17670de76c78",
      "name": "Edit Fields Menerima Pesan dari User"
    }
  ],
  "pinData": {},
  "connections": {
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Kantin PCR",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Edit Fields Menerima Pesan dari User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Kantin PCR",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Kantin PCR": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Session ID dengan Menu dari Sheet": {
      "main": [
        [
          {
            "node": "AI Agent Kantin PCR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request Mengambil Data Menu dari Sheet": {
      "main": [
        [
          {
            "node": "Merge Session ID dengan Menu dari Sheet",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Edit Fields Menerima Pesan dari User": {
      "main": [
        [
          {
            "node": "HTTP Request Mengambil Data Menu dari Sheet",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Session ID dengan Menu dari Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "6c029409-b6d4-410c-9133-c058b9425819",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d1ed88dcfab7a19e5f5a66157612b7a1984e6e8072f3019ec4dce2ceddaf0824"
  },
  "id": "UR5q4l1kgRvCuSwX",
  "tags": []
}